<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	This is an example modification file for SMF packages.

	ATTENTION: If you are trying to install this manually, you should try
	the package manager.  If it will not work for you, please take a look
	at the following for information on this format:
		http://mods.simplemachines.org/docs/manual-install.php

================================================================================

	Modification files can be used to modify files so that they do what
	your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification">

    <id>digger:Watermark.light</id>
    <version>1.7</version>

    <file name="$sourcedir/Aeva-Gallery.php" error="skip">

        <operation>

            <search position="after"><![CDATA[
	header('Content-Length: ' . ($seek_end - $seek_start + 1));
]]></search>

            <add><![CDATA[

	// * Watermark Mod by Digger
	global $modSettings;
	if (!empty($modSettings['watermarkEnabled']))
	{
    global $sourcedir;
    require_once($sourcedir . '/Subs-Watermark.php');
	}
	else
	// Watermark Mod by Digger *
]]></add>

        </operation>

        <operation>

            <search position="after"><![CDATA[
	// If the file is over 1.5MB, readfile() may have some issues.
]]></search>

            <add><![CDATA[
	// * Watermark Mod by Digger
  if (empty($modSettings['watermarkEnabled']) || !@watermark($path))
  // Watermark Mod by Digger *
]]></add>

        </operation>

    </file>

    <file name="$sourcedir/Aeva-Gallery2.php" error="skip">

        <operation>

            <search position="after"><![CDATA[
		// Add this to the archive.
]]></search>

            <add><![CDATA[
		// * Watermark Mod by Digger
		global $modSettings;
		if (!empty($modSettings['watermarkEnabled']))
		{
    	global $sourcedir;
    	require_once($sourcedir . '/Subs-Watermark.php');
    	$watermarked = @watermark($amSettings['data_dir_path'] . '/' . $item['directory'] . '/' . aeva_getEncryptedFilename($item['filename'], $item['id_file']), $amSettings['data_dir_path'] . '/tmp/' . $item['filename'] . '.watermarked');

			// Add this watermarked file to the archive.
			$zip->addFileDataToCache(empty($watermarked) ? file_get_contents($amSettings['data_dir_path'] . '/' . $item['directory'] . '/' . aeva_getEncryptedFilename($item['filename'], $item['id_file'])) : file_get_contents($amSettings['data_dir_path'] . '/tmp/' . $item['filename'] . '.watermarked'), $item['filename'], $amSettings['data_dir_path'] . '/tmp/' . $user_info['id'] . '_' . $_SESSION['aeva_mdl']['album']);

			if (!empty($watermarked)) @unlink($amSettings['data_dir_path'] . '/tmp/' . $item['filename'] . '.watermarked');
		}
		else
		// Watermark Mod by Digger *
]]></add>

        </operation>

    </file>

    <file name="$boarddir/MGalleryItem.php" error="skip">

        <operation>

            <search position="after"><![CDATA[
header('Content-Length: ' . filesize($path));
]]></search>

            <add><![CDATA[

// * Watermark Mod by Digger
global $modSettings;
if (!empty($modSettings['watermarkEnabled']))
{
	global $sourcedir;
  require_once($sourcedir . '/Subs-Watermark.php');
}
else
// Watermark Mod by Digger *
]]></add>

        </operation>

        <operation>

            <search position="after"><![CDATA[
// If the file is over 1.5MB, readfile() may have some issues.
]]></search>

            <add><![CDATA[
// * Watermark Mod by Digger
if (empty($modSettings['watermarkEnabled']) || !@watermark($path))
// Watermark Mod by Digger *
]]></add>

        </operation>

    </file>

</modification>
